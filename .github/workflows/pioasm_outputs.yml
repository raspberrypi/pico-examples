name: Check pioasm output files
on: [push, pull_request]

jobs:
  check-pioasm-outputs:
    # Prevent running twice for PRs from same repo
    if: github.repository_owner == 'raspberrypi' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name != github.event.pull_request.base.repo.full_name)
    runs-on: [self-hosted, Linux, X64]

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Checkout pico-sdk/develop
      uses: actions/checkout@v4
      with:
        repository: raspberrypi/pico-sdk
        ref: develop
        path: pico-sdk

    - name: Rebuild pioasm outputs
      run: PICO_SDK_PATH=${{github.workspace}}/pico-sdk ./update_pioasm_outputs.sh

    - name: Check pioasm outputs for changes
      run: |
        if git status --porcelain | grep -q '^ M'; then
          echo "::error title=outdated-files::Autogenerated pioasm output files are out of date - update by running update_pioasm_outputs.sh"
          exit 1
        fi

